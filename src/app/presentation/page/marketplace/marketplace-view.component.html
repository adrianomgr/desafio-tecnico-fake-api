<p-toast></p-toast>
<div class="marketplace-container">
  <div class="filters-section p-4 bg-gray-50 border-b">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Search -->
      <div class="flex flex-column gap-2">
        <label for="search" class="text-sm font-medium">Buscar produtos</label>
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input
            id="search"
            type="text"
            pInputText
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange($event)"
            placeholder="Digite para buscar..."
            class="w-full"
          />
        </span>
      </div>

      <!-- Category Filter -->
      <div class="flex flex-column gap-2">
        <label for="category" class="text-sm font-medium">Categoria</label>
        <p-select
          id="category"
          [options]="categoryOptions"
          [(ngModel)]="selectedCategory"
          (onChange)="onCategoryChange($event)"
          placeholder="Todas as categorias"
          class="w-full"
          [showClear]="true"
        ></p-select>
      </div>

      <!-- Sort -->
      <div class="flex flex-column gap-2">
        <label for="sort" class="text-sm font-medium">Ordenar por preço</label>
        <p-select
          id="sort"
          [options]="sortOptions"
          [(ngModel)]="sortOrder"
          (onChange)="onSortChange($event)"
          placeholder="Ordenação"
          class="w-full"
          [showClear]="true"
        ></p-select>
      </div>
    </div>
  </div>

  <!-- Loading -->
  @if (loading) {
  <div class="flex justify-content-center p-8">
    <p-progressSpinner></p-progressSpinner>
  </div>
  }

  <!-- Error -->
  @if (error) {
  <div class="p-4">
    <div class="p-message p-message-error">
      <span class="p-message-icon pi pi-times-circle"></span>
      <div class="p-message-text">
        <p>Erro ao carregar produtos. Tente novamente.</p>
      </div>
    </div>
  </div>
  }

  <!-- Products Grid -->
  @if (!loading && !error) {
  <div class="products-grid p-4">
    @if (filteredProducts.length === 0) {
    <div class="text-center p-8">
      <i class="pi pi-search text-6xl text-gray-400 mb-4"></i>
      <p class="text-gray-600 text-lg">Nenhum produto encontrado</p>
      <p class="text-gray-500">Tente ajustar os filtros de busca</p>
    </div>
    }

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      @for (product of filteredProducts; track product.id) {
      <p-card
        class="product-card cursor-pointer hover:shadow-lg transition-shadow"
        (click)="viewProductDetail(product.id)"
        (keyup.enter)="viewProductDetail(product.id)"
        tabindex="0"
      >
        <ng-template pTemplate="header">
          <div class="product-image-container">
            <p-image
              [src]="product.image"
              [alt]="product.title"
              width="200"
              height="200"
              class="product-image"
              [preview]="false"
            ></p-image>
          </div>
        </ng-template>

        <div class="product-content">
          <h3 class="product-title text-lg font-semibold mb-2 line-clamp-2">
            {{ product.title }}
          </h3>

          <p class="product-description text-gray-600 text-sm mb-3 line-clamp-3">
            {{ product.description }}
          </p>

          <div class="flex justify-content-between align-items-center mb-3">
            <span class="product-price text-2xl font-bold text-green-600">
              {{ product.price | currency : 'USD' : 'symbol' : '1.2-2' }}
            </span>
            <p-tag
              [value]="product.category | categoryLabel"
              [severity]="product.category | categorySeverity"
              class="mb-2"
            ></p-tag>
          </div>

          @if (product.rating) {
          <div class="flex align-items-center gap-2 mb-3">
            <p-rating [(ngModel)]="product.rating.rate" [readonly]="true" [stars]="5"></p-rating>
            <span class="text-sm text-gray-600">({{ product.rating.count }})</span>
          </div>
          }
        </div>

        <ng-template pTemplate="footer">
          <div class="flex gap-2">
            <p-button
              label="Ver Detalhes"
              icon="pi pi-eye"
              class="flex-1"
              [outlined]="true"
              (onClick)="viewProductDetail(product.id); $event.stopPropagation()"
            ></p-button>
            <p-button
              label="Adicionar ao Carrinho"
              icon="pi pi-shopping-cart"
              class="flex-1"
              (onClick)="addToCart(product); $event.stopPropagation()"
            ></p-button>
          </div>
        </ng-template>
      </p-card>
      }
    </div>
  </div>
  }
</div>
